name: 从 cfnew 同步 Releases （新）

on:
  workflow_dispatch:  # 手动触发
  schedule:
    - cron: '0 */6 * * *'  # 每6小时自动检查一次

jobs:
  sync-release:
    runs-on: ubuntu-latest
    
    steps:
      - name: 检出仓库
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: 获取 cfnew 最新发布
        id: get_latest
        run: |
          # 获取最新 release 信息
          echo "正在获取最新发布信息..."
          LATEST_RELEASE=$(curl -s https://api.github.com/repos/byJoey/cfnew/releases/latest)
          
          # 使用 sed 提取版本号（兼容性更好）
          VERSION=$(echo "$LATEST_RELEASE" | sed -n 's/.*"tag_name": "\([^"]*\)".*/\1/p')
          
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "最新版本: $VERSION"
          
          # 获取所有 assets 文件
          ASSETS_URL=$(echo "$LATEST_RELEASE" | sed -n 's/.*"assets_url": "\([^"]*\)".*/\1/p')
          echo "正在获取文件列表..."
          ASSETS=$(curl -s "$ASSETS_URL")
          
          # 提取第一个 asset 的下载 URL 和文件名
          DOWNLOAD_URL=$(echo "$ASSETS" | sed -n 's/.*"browser_download_url": "\([^"]*\)".*/\1/p' | head -1)
          FILE_NAME=$(echo "$ASSETS" | sed -n 's/.*"name": "\([^"]*\)".*/\1/p' | head -1)
          
          echo "download_url=$DOWNLOAD_URL" >> $GITHUB_OUTPUT
          echo "file_name=$FILE_NAME" >> $GITHUB_OUTPUT
          echo "下载 URL: $DOWNLOAD_URL"
          echo "文件名: $FILE_NAME"
      
      - name: 检查当前版本
        id: check_version
        run: |
          # 读取当前记录的版本，如果文件不存在则创建空文件
          if [ ! -f "VERSION.txt" ]; then
            echo "未找到版本记录文件，创建新文件"
            touch VERSION.txt
            CURRENT_VERSION=""
          else
            CURRENT_VERSION=$(cat VERSION.txt | tr -d '\n\r ')
            if [ -z "$CURRENT_VERSION" ]; then
              echo "版本记录文件为空，将进行首次更新"
            else
              echo "当前记录的版本: $CURRENT_VERSION"
            fi
          fi
          
          NEW_VERSION="${{ steps.get_latest.outputs.version }}"
          echo "latest_version=$NEW_VERSION" >> $GITHUB_OUTPUT
          echo "current_version=$CURRENT_VERSION" >> $GITHUB_OUTPUT
          
          # 如果版本文件不存在或为空，或者版本不同，则需要更新
          if [ -z "$CURRENT_VERSION" ] || [ "$CURRENT_VERSION" != "$NEW_VERSION" ]; then
            if [ -z "$CURRENT_VERSION" ]; then
              echo "首次运行，将下载文件并创建版本记录"
            else
              echo "发现新版本 $CURRENT_VERSION -> $NEW_VERSION，需要更新"
            fi
            echo "need_update=true" >> $GITHUB_OUTPUT
          else
            echo "版本相同，无需更新"
            echo "need_update=false" >> $GITHUB_OUTPUT
          fi
      
      - name: 下载文件
        if: steps.check_version.outputs.need_update == 'true'
        id: download
        run: |
          DOWNLOAD_URL="${{ steps.get_latest.outputs.download_url }}"
          FILE_NAME="${{ steps.get_latest.outputs.file_name }}"
          
          if [ -z "$DOWNLOAD_URL" ] || [ "$DOWNLOAD_URL" = "null" ]; then
            echo "错误：未找到可下载的文件"
            exit 1
          fi
          
          echo "正在下载文件: $FILE_NAME"
          curl -L -o "$FILE_NAME" "$DOWNLOAD_URL"
          
          if [ ! -f "$FILE_NAME" ]; then
            echo "错误：下载失败"
            exit 1
          fi
          
          echo "下载成功: $FILE_NAME"
          
          # 检查文件是否为zip格式
          if file "$FILE_NAME" | grep -q "Zip archive"; then
            echo "文件是ZIP格式，可以解压"
            echo "is_zip=true" >> $GITHUB_OUTPUT
          else
            echo "文件不是ZIP格式，将直接保存"
            echo "is_zip=false" >> $GITHUB_OUTPUT
          fi
      
      - name: 解压ZIP文件
        if: steps.check_version.outputs.need_update == 'true' && steps.download.outputs.is_zip == 'true'
        run: |
          FILE_NAME="${{ steps.get_latest.outputs.file_name }}"
          
          echo "开始解压ZIP文件: $FILE_NAME"
          
          # 创建临时解压目录
          mkdir -p temp_extract
          
          # 解压ZIP文件
          unzip -o "$FILE_NAME" -d temp_extract/
          
          # 检查解压结果
          echo "解压完成，查看解压出的文件:"
          ls -la temp_extract/
          
          # 移动所有文件到根目录（覆盖现有文件）
          echo "移动文件到根目录..."
          # 使用shopt处理隐藏文件
          shopt -s dotglob
          mv -f temp_extract/* . 2>/dev/null || true
          shopt -u dotglob
          
          # 只清理临时目录，保留原始ZIP文件
          rm -rf temp_extract
          
          echo "ZIP文件解压完成，所有文件已移动到根目录，原始压缩包已保留"
      
      - name: 更新版本记录
        if: steps.check_version.outputs.need_update == 'true'
        run: |
          VERSION="${{ steps.get_latest.outputs.version }}"
          
          # 写入版本号
          echo "$VERSION" > VERSION.txt
          echo "版本记录已创建/更新: $VERSION"
          
          # 验证文件是否成功写入
          if [ -f "VERSION.txt" ] && [ -s "VERSION.txt" ]; then
            echo "✓ 版本记录文件创建成功"
          else
            echo "✗ 警告：版本记录文件可能未正确创建"
          fi
      
      - name: 提交并推送更改
        if: steps.check_version.outputs.need_update == 'true'
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          
          git add -A
          
          if git diff --staged --quiet; then
            echo "没有变更需要提交"
          else
            git commit -m "自动同步: 更新到 cfnew ${{ steps.get_latest.outputs.version }}"
            git push
            echo "已提交并推送更新"
          fi
      
      - name: 输出摘要
        run: |
          echo "## 同步结果" >> $GITHUB_STEP_SUMMARY
          echo "- 最新版本: ${{ steps.get_latest.outputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "- 当前版本: ${{ steps.check_version.outputs.current_version }}" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ steps.check_version.outputs.need_update }}" = "true" ]; then
            echo "- 状态: ✅ 已更新到新版本" >> $GITHUB_STEP_SUMMARY
            echo "- 下载文件: ${{ steps.get_latest.outputs.file_name }}" >> $GITHUB_STEP_SUMMARY
            if [ "${{ steps.download.outputs.is_zip }}" = "true" ]; then
              echo "- 处理方式: ZIP文件已解压到根目录，原始压缩包已保留" >> $GITHUB_STEP_SUMMARY
            else
              echo "- 处理方式: 文件已保存到根目录" >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "- 状态: ⏭️ 版本相同，无需更新" >> $GITHUB_STEP_SUMMARY
          fi
